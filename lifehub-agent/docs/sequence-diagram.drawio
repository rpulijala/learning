<mxfile host="app.diagrams.net" modified="2026-01-03T23:05:00.000Z" agent="Mozilla/5.0" version="22.1.0" type="device">
  <diagram name="Sequence Diagram" id="sequence-diagram">
    <mxGraphModel dx="1600" dy="900" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1400" pageHeight="1800" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        
        <!-- Title -->
        <mxCell id="title" value="LifeHub Agent - Request Flow Sequence Diagram" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=24;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="400" y="20" width="600" height="40" as="geometry" />
        </mxCell>
        
        <!-- Example Query Box -->
        <mxCell id="query-box" value="Example: &quot;What's in my notes about running? Also search the web for marathon tips.&quot;" style="shape=callout;whiteSpace=wrap;html=1;perimeter=calloutPerimeter;size=30;position=0.5;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=11" vertex="1" parent="1">
          <mxGeometry x="450" y="70" width="500" height="50" as="geometry" />
        </mxCell>
        
        <!-- Participant Headers -->
        <mxCell id="user-head" value="User" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="40" y="140" width="80" height="40" as="geometry" />
        </mxCell>
        <mxCell id="frontend-head" value="Frontend&#xa;(Next.js)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="160" y="140" width="80" height="40" as="geometry" />
        </mxCell>
        <mxCell id="fastapi-head" value="FastAPI&#xa;Backend" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="280" y="140" width="80" height="40" as="geometry" />
        </mxCell>
        <mxCell id="planner-head" value="Planner&#xa;Agent" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="400" y="140" width="80" height="40" as="geometry" />
        </mxCell>
        <mxCell id="worker-head" value="Worker&#xa;Agent" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="520" y="140" width="80" height="40" as="geometry" />
        </mxCell>
        <mxCell id="explainer-head" value="Explainer&#xa;Agent" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="640" y="140" width="80" height="40" as="geometry" />
        </mxCell>
        <mxCell id="llm-head" value="LLM&#xa;(OpenAI)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="760" y="140" width="80" height="40" as="geometry" />
        </mxCell>
        <mxCell id="tools-head" value="Tools" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e6f3ff;strokeColor=#0066CC;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="880" y="140" width="80" height="40" as="geometry" />
        </mxCell>
        <mxCell id="mcp-head" value="MCP&#xa;Server" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="1000" y="140" width="80" height="40" as="geometry" />
        </mxCell>
        <mxCell id="chroma-head" value="ChromaDB" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="1120" y="140" width="80" height="40" as="geometry" />
        </mxCell>
        <mxCell id="embed-head" value="Embeddings&#xa;API" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="1240" y="140" width="80" height="40" as="geometry" />
        </mxCell>
        
        <!-- Lifelines -->
        <mxCell id="user-line" value="" style="endArrow=none;dashed=1;html=1;strokeWidth=1;strokeColor=#999999" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="80" y="180" as="sourcePoint" />
            <mxPoint x="80" y="1700" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="frontend-line" value="" style="endArrow=none;dashed=1;html=1;strokeWidth=1;strokeColor=#999999" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="200" y="180" as="sourcePoint" />
            <mxPoint x="200" y="1700" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="fastapi-line" value="" style="endArrow=none;dashed=1;html=1;strokeWidth=1;strokeColor=#999999" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="320" y="180" as="sourcePoint" />
            <mxPoint x="320" y="1700" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="planner-line" value="" style="endArrow=none;dashed=1;html=1;strokeWidth=1;strokeColor=#999999" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="440" y="180" as="sourcePoint" />
            <mxPoint x="440" y="1700" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="worker-line" value="" style="endArrow=none;dashed=1;html=1;strokeWidth=1;strokeColor=#999999" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="560" y="180" as="sourcePoint" />
            <mxPoint x="560" y="1700" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="explainer-line" value="" style="endArrow=none;dashed=1;html=1;strokeWidth=1;strokeColor=#999999" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="680" y="180" as="sourcePoint" />
            <mxPoint x="680" y="1700" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="llm-line" value="" style="endArrow=none;dashed=1;html=1;strokeWidth=1;strokeColor=#999999" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="800" y="180" as="sourcePoint" />
            <mxPoint x="800" y="1700" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="tools-line" value="" style="endArrow=none;dashed=1;html=1;strokeWidth=1;strokeColor=#999999" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="920" y="180" as="sourcePoint" />
            <mxPoint x="920" y="1700" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="mcp-line" value="" style="endArrow=none;dashed=1;html=1;strokeWidth=1;strokeColor=#999999" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1040" y="180" as="sourcePoint" />
            <mxPoint x="1040" y="1700" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="chroma-line" value="" style="endArrow=none;dashed=1;html=1;strokeWidth=1;strokeColor=#999999" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1160" y="180" as="sourcePoint" />
            <mxPoint x="1160" y="1700" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="embed-line" value="" style="endArrow=none;dashed=1;html=1;strokeWidth=1;strokeColor=#999999" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1280" y="180" as="sourcePoint" />
            <mxPoint x="1280" y="1700" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- Phase 1: Request Initiation -->
        <mxCell id="phase1-label" value="Phase 1: Request Initiation" style="text;html=1;strokeColor=#6c8ebf;fillColor=#dae8fc;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=1;fontSize=12;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="40" y="200" width="180" height="25" as="geometry" />
        </mxCell>
        
        <!-- 1. User types message -->
        <mxCell id="msg1" value="1. Type message" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#0066CC" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="80" y="240" as="sourcePoint" />
            <mxPoint x="200" y="240" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- 2. POST /chat -->
        <mxCell id="msg2" value="2. POST /chat {messages, provider}" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#0066CC" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="200" y="270" as="sourcePoint" />
            <mxPoint x="320" y="270" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- 3. SSE start -->
        <mxCell id="msg3" value="3. SSE: {type: &quot;start&quot;}" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#009900;dashed=1" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="320" y="300" as="sourcePoint" />
            <mxPoint x="200" y="300" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- Phase 2: Planning -->
        <mxCell id="phase2-label" value="Phase 2: Planning (LLM Call #1)" style="text;html=1;strokeColor=#d79b00;fillColor=#ffe6cc;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=1;fontSize=12;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="40" y="330" width="200" height="25" as="geometry" />
        </mxCell>
        
        <!-- 4. Invoke planner -->
        <mxCell id="msg4" value="4. Invoke planner node" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#d79b00" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="320" y="370" as="sourcePoint" />
            <mxPoint x="440" y="370" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- Planner activation box -->
        <mxCell id="planner-act" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00" vertex="1" parent="1">
          <mxGeometry x="435" y="370" width="10" height="150" as="geometry" />
        </mxCell>
        
        <!-- 5. LLM call for planning -->
        <mxCell id="msg5" value="5. planner_model.invoke()&#xa;[SystemPrompt + UserMessage]" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#b85450" edge="1" parent="1">
          <mxGeometry x="-0.2" width="50" height="50" relative="1" as="geometry">
            <mxPoint x="445" y="400" as="sourcePoint" />
            <mxPoint x="800" y="400" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        
        <!-- LLM activation box -->
        <mxCell id="llm-act1" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450" vertex="1" parent="1">
          <mxGeometry x="795" y="400" width="10" height="60" as="geometry" />
        </mxCell>
        
        <!-- LLM thinking note -->
        <mxCell id="llm-note1" value="LLM analyzes request,&#xa;identifies tools needed,&#xa;creates JSON plan" style="shape=note;whiteSpace=wrap;html=1;size=14;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=9" vertex="1" parent="1">
          <mxGeometry x="820" y="390" width="120" height="50" as="geometry" />
        </mxCell>
        
        <!-- 6. Return JSON plan -->
        <mxCell id="msg6" value="6. Return JSON plan:&#xa;{plan: [{step:1, tool:&quot;search_notes&quot;},&#xa;{step:2, tool:&quot;brave_web_search&quot;},&#xa;{step:3, tool:null}]}" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#b85450" edge="1" parent="1">
          <mxGeometry x="0.2" width="50" height="50" relative="1" as="geometry">
            <mxPoint x="795" y="460" as="sourcePoint" />
            <mxPoint x="445" y="460" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        
        <!-- 7. SSE plan (debug) -->
        <mxCell id="msg7" value="7. SSE: {type: &quot;plan&quot;, plan: [...]}" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#009900;dashed=1" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="320" y="500" as="sourcePoint" />
            <mxPoint x="200" y="500" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- Phase 3: Execution -->
        <mxCell id="phase3-label" value="Phase 3: Tool Execution (No LLM)" style="text;html=1;strokeColor=#0066CC;fillColor=#e6f3ff;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=1;fontSize=12;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="40" y="530" width="220" height="25" as="geometry" />
        </mxCell>
        
        <!-- 8. Invoke worker -->
        <mxCell id="msg8" value="8. Invoke worker node" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#d79b00" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="440" y="570" as="sourcePoint" />
            <mxPoint x="560" y="570" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- Worker activation box -->
        <mxCell id="worker-act" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00" vertex="1" parent="1">
          <mxGeometry x="555" y="570" width="10" height="450" as="geometry" />
        </mxCell>
        
        <!-- Step 1: search_notes -->
        <mxCell id="step1-label" value="Step 1: search_notes (RAG)" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;fontStyle=2;fontColor=#666666" vertex="1" parent="1">
          <mxGeometry x="570" y="590" width="150" height="20" as="geometry" />
        </mxCell>
        
        <!-- 9. SSE tool_start -->
        <mxCell id="msg9" value="9. SSE: {type: &quot;tool_start&quot;, name: &quot;search_notes&quot;}" style="endArrow=classic;html=1;strokeWidth=1;strokeColor=#009900;dashed=1" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="320" y="615" as="sourcePoint" />
            <mxPoint x="200" y="615" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- 10. Invoke search_notes -->
        <mxCell id="msg10" value="10. tool.invoke({query: &quot;running&quot;})" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#0066CC" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="565" y="640" as="sourcePoint" />
            <mxPoint x="920" y="640" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- Tools activation -->
        <mxCell id="tools-act1" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e6f3ff;strokeColor=#0066CC" vertex="1" parent="1">
          <mxGeometry x="915" y="640" width="10" height="120" as="geometry" />
        </mxCell>
        
        <!-- 11. Get embedding -->
        <mxCell id="msg11" value="11. get_single_embedding(&quot;running&quot;)" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#666666" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="925" y="670" as="sourcePoint" />
            <mxPoint x="1280" y="670" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- Embeddings activation -->
        <mxCell id="embed-act" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666" vertex="1" parent="1">
          <mxGeometry x="1275" y="670" width="10" height="30" as="geometry" />
        </mxCell>
        
        <!-- 12. Return embedding -->
        <mxCell id="msg12" value="12. Return vector [0.023, -0.156, ...]" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#666666" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1275" y="700" as="sourcePoint" />
            <mxPoint x="925" y="700" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- 13. Query ChromaDB -->
        <mxCell id="msg13" value="13. collection.query(embedding, n=5)" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#666666" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="925" y="720" as="sourcePoint" />
            <mxPoint x="1160" y="720" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- ChromaDB activation -->
        <mxCell id="chroma-act" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666" vertex="1" parent="1">
          <mxGeometry x="1155" y="720" width="10" height="30" as="geometry" />
        </mxCell>
        
        <!-- 14. Return chunks -->
        <mxCell id="msg14" value="14. Return matching note chunks" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#666666" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1155" y="750" as="sourcePoint" />
            <mxPoint x="925" y="750" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- 15. Return to worker -->
        <mxCell id="msg15" value="15. Return [{content: &quot;My running plan...&quot;}]" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#0066CC" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="915" y="770" as="sourcePoint" />
            <mxPoint x="565" y="770" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- 16. SSE tool_end -->
        <mxCell id="msg16" value="16. SSE: {type: &quot;tool_end&quot;, name: &quot;search_notes&quot;, output: [...]}" style="endArrow=classic;html=1;strokeWidth=1;strokeColor=#009900;dashed=1" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="320" y="795" as="sourcePoint" />
            <mxPoint x="200" y="795" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- Step 2: brave_web_search -->
        <mxCell id="step2-label" value="Step 2: brave_web_search (MCP)" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;fontStyle=2;fontColor=#666666" vertex="1" parent="1">
          <mxGeometry x="570" y="820" width="160" height="20" as="geometry" />
        </mxCell>
        
        <!-- 17. SSE tool_start brave -->
        <mxCell id="msg17" value="17. SSE: {type: &quot;tool_start&quot;, name: &quot;brave_web_search&quot;}" style="endArrow=classic;html=1;strokeWidth=1;strokeColor=#009900;dashed=1" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="320" y="845" as="sourcePoint" />
            <mxPoint x="200" y="845" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- 18. Invoke MCP tool -->
        <mxCell id="msg18" value="18. tool.invoke({query: &quot;marathon tips&quot;})" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#d6b656" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="565" y="870" as="sourcePoint" />
            <mxPoint x="1040" y="870" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- MCP activation -->
        <mxCell id="mcp-act" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656" vertex="1" parent="1">
          <mxGeometry x="1035" y="870" width="10" height="80" as="geometry" />
        </mxCell>
        
        <!-- MCP note -->
        <mxCell id="mcp-note" value="MCP Client:&#xa;1. stdio_client()&#xa;2. session.init()&#xa;3. call_tool()&#xa;→ Brave API" style="shape=note;whiteSpace=wrap;html=1;size=14;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=9" vertex="1" parent="1">
          <mxGeometry x="1060" y="860" width="100" height="70" as="geometry" />
        </mxCell>
        
        <!-- 19. Return MCP results -->
        <mxCell id="msg19" value="19. Return web search results" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#d6b656" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1035" y="950" as="sourcePoint" />
            <mxPoint x="565" y="950" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- 20. SSE tool_end brave -->
        <mxCell id="msg20" value="20. SSE: {type: &quot;tool_end&quot;, name: &quot;brave_web_search&quot;, output: &quot;...&quot;}" style="endArrow=classic;html=1;strokeWidth=1;strokeColor=#009900;dashed=1" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="320" y="975" as="sourcePoint" />
            <mxPoint x="200" y="975" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- Step 3 note -->
        <mxCell id="step3-label" value="Step 3: Synthesis (no tool, just logged)" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;fontStyle=2;fontColor=#666666" vertex="1" parent="1">
          <mxGeometry x="570" y="1000" width="200" height="20" as="geometry" />
        </mxCell>
        
        <!-- Phase 4: Explanation -->
        <mxCell id="phase4-label" value="Phase 4: Explanation (LLM Call #2 - STREAMING)" style="text;html=1;strokeColor=#b85450;fillColor=#f8cecc;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=1;fontSize=12;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="40" y="1040" width="280" height="25" as="geometry" />
        </mxCell>
        
        <!-- 21. Invoke explainer -->
        <mxCell id="msg21" value="21. Invoke explainer node" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#d79b00" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="560" y="1080" as="sourcePoint" />
            <mxPoint x="680" y="1080" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- Explainer activation -->
        <mxCell id="explainer-act" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00" vertex="1" parent="1">
          <mxGeometry x="675" y="1080" width="10" height="350" as="geometry" />
        </mxCell>
        
        <!-- 22. LLM call for explanation -->
        <mxCell id="msg22" value="22. explainer_model.invoke()&#xa;[SystemPrompt + Plan + ContextLog]" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#b85450" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="685" y="1110" as="sourcePoint" />
            <mxPoint x="800" y="1110" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- LLM activation 2 -->
        <mxCell id="llm-act2" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450" vertex="1" parent="1">
          <mxGeometry x="795" y="1110" width="10" height="280" as="geometry" />
        </mxCell>
        
        <!-- LLM streaming note -->
        <mxCell id="llm-note2" value="LLM generates&#xa;response with&#xa;STREAMING&#xa;enabled" style="shape=note;whiteSpace=wrap;html=1;size=14;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=9" vertex="1" parent="1">
          <mxGeometry x="820" y="1100" width="100" height="60" as="geometry" />
        </mxCell>
        
        <!-- Streaming tokens -->
        <mxCell id="msg23" value="23. Stream token: &quot;Based&quot;" style="endArrow=classic;html=1;strokeWidth=1;strokeColor=#b85450" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="795" y="1180" as="sourcePoint" />
            <mxPoint x="685" y="1180" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="msg24" value="24. SSE: {type: &quot;token&quot;, content: &quot;Based&quot;}" style="endArrow=classic;html=1;strokeWidth=1;strokeColor=#009900;dashed=1" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="320" y="1200" as="sourcePoint" />
            <mxPoint x="200" y="1200" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="msg25" value="25. Stream token: &quot; on&quot;" style="endArrow=classic;html=1;strokeWidth=1;strokeColor=#b85450" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="795" y="1230" as="sourcePoint" />
            <mxPoint x="685" y="1230" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="msg26" value="26. SSE: {type: &quot;token&quot;, content: &quot; on&quot;}" style="endArrow=classic;html=1;strokeWidth=1;strokeColor=#009900;dashed=1" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="320" y="1250" as="sourcePoint" />
            <mxPoint x="200" y="1250" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- Streaming dots -->
        <mxCell id="dots" value="... (continues streaming tokens)" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;fontStyle=2;fontColor=#666666" vertex="1" parent="1">
          <mxGeometry x="400" y="1280" width="200" height="20" as="geometry" />
        </mxCell>
        
        <mxCell id="msg27" value="27. Stream final token" style="endArrow=classic;html=1;strokeWidth=1;strokeColor=#b85450" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="795" y="1330" as="sourcePoint" />
            <mxPoint x="685" y="1330" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="msg28" value="28. SSE: {type: &quot;token&quot;, content: &quot;...&quot;}" style="endArrow=classic;html=1;strokeWidth=1;strokeColor=#009900;dashed=1" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="320" y="1350" as="sourcePoint" />
            <mxPoint x="200" y="1350" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="msg29" value="29. LLM done" style="endArrow=classic;html=1;strokeWidth=1;strokeColor=#b85450" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="795" y="1390" as="sourcePoint" />
            <mxPoint x="685" y="1390" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- Phase 5: Completion -->
        <mxCell id="phase5-label" value="Phase 5: Completion" style="text;html=1;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=1;fontSize=12;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="40" y="1450" width="150" height="25" as="geometry" />
        </mxCell>
        
        <!-- 30. Return final answer -->
        <mxCell id="msg30" value="30. Return {final_answer: &quot;...&quot;}" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#d79b00" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="675" y="1490" as="sourcePoint" />
            <mxPoint x="320" y="1490" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- 31. SSE end -->
        <mxCell id="msg31" value="31. SSE: {type: &quot;end&quot;}" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#009900;dashed=1" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="320" y="1520" as="sourcePoint" />
            <mxPoint x="200" y="1520" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- 32. Display complete -->
        <mxCell id="msg32" value="32. Display complete response" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#0066CC" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="200" y="1550" as="sourcePoint" />
            <mxPoint x="80" y="1550" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- Legend -->
        <mxCell id="legend-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#000000" vertex="1" parent="1">
          <mxGeometry x="40" y="1590" width="400" height="100" as="geometry" />
        </mxCell>
        <mxCell id="legend-title" value="Legend" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=12;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="50" y="1595" width="60" height="20" as="geometry" />
        </mxCell>
        <mxCell id="legend-sync" value="→ Synchronous call" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;fontColor=#0066CC" vertex="1" parent="1">
          <mxGeometry x="50" y="1620" width="120" height="20" as="geometry" />
        </mxCell>
        <mxCell id="legend-sse" value="⇢ SSE event (to frontend)" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;fontColor=#009900" vertex="1" parent="1">
          <mxGeometry x="50" y="1640" width="150" height="20" as="geometry" />
        </mxCell>
        <mxCell id="legend-llm" value="→ LLM API call" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;fontColor=#b85450" vertex="1" parent="1">
          <mxGeometry x="50" y="1660" width="100" height="20" as="geometry" />
        </mxCell>
        <mxCell id="legend-mcp" value="→ MCP call" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;fontColor=#d6b656" vertex="1" parent="1">
          <mxGeometry x="200" y="1620" width="80" height="20" as="geometry" />
        </mxCell>
        <mxCell id="legend-db" value="→ Database/API call" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;fontColor=#666666" vertex="1" parent="1">
          <mxGeometry x="200" y="1640" width="120" height="20" as="geometry" />
        </mxCell>
        
        <!-- Summary box -->
        <mxCell id="summary-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450" vertex="1" parent="1">
          <mxGeometry x="480" y="1590" width="300" height="100" as="geometry" />
        </mxCell>
        <mxCell id="summary-title" value="LLM Calls Summary" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=12;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="490" y="1595" width="150" height="20" as="geometry" />
        </mxCell>
        <mxCell id="summary-text" value="• LLM Call #1: Planner (non-streaming)&#xa;• LLM Call #2: Explainer (STREAMING)&#xa;&#xa;Worker does NOT call LLM - only tools!" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=10" vertex="1" parent="1">
          <mxGeometry x="490" y="1620" width="280" height="60" as="geometry" />
        </mxCell>
        
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
